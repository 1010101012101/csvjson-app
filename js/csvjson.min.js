/* CSVJSON | (c) 2013 Martin Drapeau | https://github.com/martindrapeau/CSVJSON */
// js/src/json3.js
if(typeof JSON3!=='object'){JSON3={};}
(function(){'use strict';function f(n){return n<10?'0'+n:n;}
if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+
f(this.getUTCMonth()+1)+'-'+
f(this.getUTCDate())+'T'+
f(this.getUTCHours())+':'+
f(this.getUTCMinutes())+':'+
f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf();};}
var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,keyable=/^[a-zA-Z_$][0-9a-zA-Z_$]*$/,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}
function condQuoteKey(string){return keyable.test(string)?string:quote(string);}
function str(key,holder,dropQuotesOnKeys){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}
if(typeof rep==='function'){value=rep.call(holder,key,value);}
switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}
gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}
v=partial.length===0?'[]':gap?'[\n'+gap+partial.join(',\n'+gap)+'\n'+mind+']':'['+partial.join(',')+']';gap=mind;return v;}
if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==='string'){k=rep[i];v=str(k,value);if(v){partial.push((dropQuotesOnKeys?condQuoteKey(k):quote(k))+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push((dropQuotesOnKeys?condQuoteKey(k):quote(k))+(gap?': ':':')+v);}}}}
v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}
if(typeof JSON3.stringify!=='function'){JSON3.stringify=function(value,replacer,space,dropQuotesOnKeys){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}
rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}
return str('',{'':value},dropQuotesOnKeys);};}
if(typeof JSON3.parse!=='function'){JSON3.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}
return reviver.call(holder,key,value);}
text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+
('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}
if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}
throw new SyntaxError('JSON.parse');};}}());
// js/src/csv2json.js
CSVJSON.csv2json=function(){var errorDetectingSeparator="We could not detect the separator.",errorEmpty="Please upload a file or type in something.",errorEmptyHeader="Could not detect header. Ensure first row cotains your column headers.";var uploadUrl="/csv2json/upload",charMap={comma:',',semiColon:';',tab:'\t'};var $file=$('#fileupload'),$separator=$('input[type=radio][name="separator"]'),$csv=$('#csv'),$json=$('#json'),$clear=$('a.clear'),$convert=$('#convert, a.convert');function getSeparator(csv){var userSpecified=$separator.filter(':checked').val(),separator=charMap[userSpecified];if(separator)return separator;var counts={},keyMax;_.each(charMap,function(c,k){var re=new RegExp(c,'g');counts[k]=(csv.match(re)||[]).length;keyMax=!keyMax||counts[k]>counts[keyMax]?k:keyMax;});return keyMax?charMap[keyMax]:undefined;}
CSVJSON.bindFileUploadToFillTextarea($file,uploadUrl,$csv);CSVJSON.bindClear($clear);CSVJSON.setInputsForSave($('input.save, textarea.save'));function err(error){CSVJSON.reportError($json,error);return false;}
$convert.click(function(e){e.preventDefault();var csv=_.trim($csv.val());if(csv.length==0)return err(errorEmpty);var separator=getSeparator(csv);if(!separator)return err(errorDetectingSeparator);console.log('separator',separator);var lines=_.lines(csv);if(lines.length==0)return err(errorEmpty);var keys=_.words(lines.shift(),separator);if(keys.length==0)return err(errorEmptyHeader);var json=[];for(var l=0;l<lines.length;l++){var row={};var items=_.words(lines[l],separator);for(var i=0;i<keys.length;i++){var value=items[i]-0;row[keys[i]]=isNaN(value)?items[i]:value;}
json.push(row);}
var result=JSON.stringify(json,null,2);$json.removeClass('error').val(result);});};
// js/src/json_beautifier.js
CSVJSON.json_beautifier=function(){var errorEmpty="Please upload a file or type in something.";var uploadUrl="/json_beautifier/upload",spaceMap={'tab':'\t','1':1,'2':2,'3':3,'4':4,'.':'.','..':'..'};var $file=$('#fileupload'),$json=$('#json'),$result=$('#result'),$resultNote=$('span.result-note'),$clear=$('a.clear'),$convert=$('#convert, a.convert');CSVJSON.bindFileUploadToFillTextarea($file,uploadUrl,$json);CSVJSON.bindClear($clear);$clear.click(function(e){$resultNote.empty();});CSVJSON.setInputsForSave($('input.save, textarea.save, select.save'));function err(error){CSVJSON.reportError($result,error);return false;}
function walkObjectAndDropQuotesOnNumbers(object){if(!_.isObject(object))return;_.each(object,function(value,key){if(_.isString(value)){var number=value-0;object[key]=isNaN(number)?value:number;}else if(_.isObject(value)||_.isArray(value)){walkObjectAndDropQuotesOnNumbers(value);}});}
function inlineShortArraysInResult(result){var list=result.split('\n'),i=0,start=null,content=[];while(i<list.length){if(list[i].match(/\[$/)){start=i;}else if(list[i].match(/\],?$/)&&start){var inline=list[start]+content.join(' ')+_.trim(list[i]);if(inline.length<80){list.splice(start,i-start+1,inline);i=start+1;}
start=null;content=[];}else{if(start)content.push(_.trim(list[i]));}
i+=1;}
return list.join('\n');}
$convert.click(function(e){e.preventDefault();$resultNote.empty();var space=spaceMap[$('#space').val()],dropQuotesOnKeys=$('#drop-quotes-on-keys').is(':checked'),dropQuotesOnNumbers=$('#drop-quotes-on-numbers').is(':checked'),inlineShortArrays=$('#inline-short-arrays').is(':checked');var json=_.trim($json.val());if(json.length==0)err(errorEmpty);var object,result;try{object=jsonlint.parse(json);if(dropQuotesOnNumbers)walkObjectAndDropQuotesOnNumbers(object);result=JSON3.stringify(object,null,space,dropQuotesOnKeys);if(inlineShortArrays)result=inlineShortArraysInResult(result);$result.removeClass('error').val(result);if(dropQuotesOnKeys)$resultNote.text('Invalid JSON, but valid Javascript');}catch(error){err(error);$resultNote.text('Invalid JSON');}});};
// js/src/jquery.cache-inputs.js
(function($){$.fn.CacheInputs=function(options){var settings=$.extend({key:'cache-inputs',inputs:['input[type=text]','input[type=radio]','input[type=checkbox]','select'],ignoreOnStart:false},options);function on_change(event){var $input=$(event.target),key=settings.key,id=$input.attr('id'),data=JSON.parse(localStorage[key]);if($input.attr('type')=='radio'||$input.attr('type')=='checkbox'){data[id]=$input.is(':checked');}else{data[id]=$input.val();}
localStorage[key]=JSON.stringify(data);}
return this.each(function(){var $el=$(this),selector=settings.inputs.join(', ');if(typeof(Storage)!=="undefined"){var key=settings.key;var data=false;if(localStorage[key]){data=JSON.parse(localStorage[key]);}
if(!data){localStorage[key]=JSON.stringify({});data=JSON.parse(localStorage[key]);}
$el.find(selector).change(on_change);if(!settings.ignoreOnStart)
$el.find(selector).each(function(){if($(this).attr('type')!='submit'){var $input=$(this),id=$input.attr('id'),value=data[id];if(value===undefined)return true;if($input.attr('type')=='radio'||$input.attr('type')=='checkbox'){if(value){$input.attr('checked',true);}else{$input.removeAttr('checked');}}else{$input.val(value);}}});}});};}(jQuery));
// js/src/main.js
$(document).ready(function(){_.mixin(_.str.exports());function baseUrl(){return window.location.protocol+'//'+window.location.hostname+'/'+CSVJSON.page;}
_.extend(CSVJSON,{init:function(){$('.container').CacheInputs({key:CSVJSON.page,ignoreOnStart:!!CSVJSON.id});if(CSVJSON.id)
CSVJSON.restore();else
CSVJSON.renderSave('active');},reportError:function($textarea,error){$textarea.addClass('error').val(error);},bindClear:function($clear){$clear.click(function(e){e.preventDefault();$('textarea.input, textarea.result').val('').removeClass('error');return false;});},bindFileUploadToFillTextarea:function($file,uploadUrl,$textarea){var $fileLabel=$file.siblings('label'),fileLabelHtml=$fileLabel.html();$file.fileupload({url:uploadUrl,progress:function(e,data){var progress=parseInt(data.loaded/data.total*100,10);$fileLabel.text(progress+'%');},success:function(result){$fileLabel.html(fileLabelHtml);$textarea.val(result);},fail:function(e,data){$fileLabel.html(fileLabelHtml);}});},$inputsForSave:[],setInputsForSave:function($inputs){CSVJSON.$inputsForSave=$inputs;},save:function(e){e.preventDefault();var url=baseUrl()+'/save';if(CSVJSON.id)url+='/'+CSVJSON.id;var data={};CSVJSON.$inputsForSave.each(function(){var $el=$(this),id=$el.attr('id'),val=$el.is('input[type=radio], input[type=checkbox]')?$el.is(':checked'):$el.val();data[id]=val;});CSVJSON.renderSave('saving');$.ajax(url,{type:'POST',data:JSON.stringify(data),contentType:'application/json'}).done(function(id){CSVJSON.id=id;var newUrl=baseUrl()+'/'+id;if(window.location.href!=newUrl){if(window.history&&window.history.pushState)
window.history.pushState("","",newUrl);else
window.location.href=newUrl;}
CSVJSON.renderSave('saved');}).fail(function(xhr){var error=xhr.responseText?xhr.responseText:'Unexpected error saving.';CSVJSON.renderSave('error',error);});return false;},restore:function(){if(!CSVJSON.data)return;_.each(CSVJSON.data,function(value,id){var $el=$('#'+id);if(!$el.length)return true;if($el.is('input[type=radio]')){if(value)$el.attr('selected','selected');}else if($el.is('input[type=checkbox]')){if(value)$el.attr('checked','checked');}else{$el.val(value);}});CSVJSON.renderSave('saved');},renderSave:function(state,error){var $save=$('#save');switch(state){case'active':if($save.hasClass('active'))return;$('#save').unbind().click(CSVJSON.save).html('<i class="glyphicon glyphicon-link"></i> Save').attr('title','Save a permanent link to come back later, or share to with a friend.'+(CSVJSON.id?' Will overwrite your previous work.':'')).closest('li').removeClass('disabled');break;case'saving':$save.unbind('click').html('<i class="glyphicon glyphicon-arrow-down"></i> Save').attr('title','Please wait...').closest('li').addClass('disabled');case'saved':$save.unbind('click').html('<i class="glyphicon glyphicon-link"></i> Saved').attr('title','Copy the URL in the address bar to share, or bookmark it to save for later.').closest('li').addClass('disabled');CSVJSON.$inputsForSave.one('change.makedirty',function(e){CSVJSON.renderSave('active');CSVJSON.$inputsForSave.unbind('.makedirty');});break;case'error':$save.unbind('click').html('<i class="glyphicon glyphicon-warning-sign"></i> Error saving').attr('title',error?error:'An unexpected error while saving.').closest('li').addClass('disabled');break;}}});var fn=CSVJSON[CSVJSON.page];if(typeof(fn)!=='function')throw"Module "+CSVJSON.page+" not found.";CSVJSON[CSVJSON.page]();CSVJSON.init();});
